<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Dispatcher</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <style>

        html {
            height: 100%;
            overflow: hidden;
            --screen-color: #D9E9DF;
            --screen-text: #1F1F1F;
        }

        * {
            user-select: none;
            font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
        }

        /*SCREEN*/

            #screen {
                -webkit-app-region: no-drag;
                position: absolute;
                background-color: var(--screen-color);
                color: var(--screen-text);
                width: calc(90% - 6px);
                height: calc(70% - 6px);
                top: 5%;
                left: 5%;
                padding: 3px;
                overflow: hidden;
                border-radius: 5px;
                box-shadow: #aaa 0 0 5px;
                font-weight: bold;
            }

            #status_bar {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 15%;
                min-height: 18px;
                background-color: var(--screen-text);
                color: var(--screen-color);
                display: flex;
                justify-content: flex-start;
                align-items: center;
            }

            #status_bar span {
                font-size: 100%;
                margin-left: 3%;
                cursor: pointer;
            }

            #status_btn {
                position: absolute;
                background-color: var(--screen-color);
                border: var(--screen-text) 1px solid;
                border-radius: 4px;
                bottom: -4px;
                right: -4px;
                height: calc(30% - 4px);
                aspect-ratio: 1/1;
                display: flex;
                justify-content: center;
                align-items: center;
                cursor: pointer;
            }

            #lst_call {
                z-index: 100;
                position: absolute;
                top: 42.5%;
                left: 50%;
                transform: translate(-50%, -50%);
                height: 65%;
                width: 55%;
                background-color: var(--screen-color);
                border-radius: 5px;
                border: var(--screen-text) 1px solid;
                display: none;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }

            #lst_call_img {
                font-size: 36px;
            }

            #lst_call_msg {
                text-align: center;
            }

            #status_nmbr {
                transform: translate(-2px, -2px);
            }

            #unit_display {
                cursor: default !important;
            }

            #job_info {
                display: flex;
                flex-direction: column;
                gap: 4px;
                padding: 6px;
                height: calc(85% - 12px);
                width: calc(100% - 12px);
            }

            #job_info > .jobInfo {
                width: 90%;
                height: 16px;
                font-size: 14px;
                overflow: hidden;
                text-overflow: clip;
                display: flex;
                align-items: center;
            }

            span[data-job=title] {
                height: 26px !important;
                font-size: 16px !important;
                text-decoration: underline;
                text-align: center;
                align-self: center;
                justify-content: center;
            }

            #job_info > .jobInfo > .material-symbols-outlined {
                height: 16px;
                font-size: 16px;
            }

            .jobTransInfo {
                position: relative;
                top: 50%;
                left: 50%;
                width: 90%;
                height: 90%;
                font-size: 14px;
                transform: translate(-50%, -50%);
                display: none;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                text-align: center;
                overflow: visible;
            }

            .jobTransInfo > .material-symbols-outlined {
                font-size: 40px;
                height: 40px;
            }

            /* SETTING DIVS */

                .ch_div {
                    background-color: var(--screen-color);
                    position: absolute;
                    height: calc(75% + 4px);
                    width: calc(90% + 4px);
                    border: var(--screen-text) 1px solid;
                    border-radius: 4px;
                    top: 10%;
                    left: 10%;
                }

                .ch_div > div {
                    width: calc(100% - 6px);
                    height: calc(100% - 6px);
                    display: flex;
                    flex-direction: column;
                    gap: 2px;
                }

                .ch_header {
                    align-self: center;
                }

                .ch_selection {
                    background: linear-gradient(var(--screen-color) 46%, var(--screen-text) 46%, var(--screen-text) 54%, var(--screen-color) 54%);
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }

                .ch_selection_active {
                    border-radius: 4px;
                    box-shadow: inset var(--screen-text) 0 0 0 7px;
                }

                .ch_selection_small {
                    background: linear-gradient(90deg, rgba(0,0,0,0) 6px, var(--screen-text) 7px, var(--screen-text) 8px, rgba(0,0,0,0) 9px);
                    width: 14px;
                    height: 60%;
                    cursor: pointer;
                }
                .ch_selection_medium {
                    background: linear-gradient(90deg, rgba(0,0,0,0) 6px, var(--screen-text) 7px, var(--screen-text) 8px, rgba(0,0,0,0) 9px);
                    width: 14px;
                    height: 90%;
                    cursor: pointer;
                }
                .ch_selection_start {
                    background: linear-gradient(90deg, var(--screen-text) 4px, rgba(0,0,0,0) 4px);
                    width: 14px;
                    height: 100%;
                    cursor: pointer;
                }
                .ch_selection_end {
                    background: linear-gradient(270deg, var(--screen-text) 4px, rgba(0,0,0,0) 4px);
                    width: 14px;
                    height: 100%;
                    cursor: pointer;
                }

                .displayOption, .soundOption {
                    padding: 0 4px;
                    display: flex;
                }

                #opacity_selector, #contrast_selector, #volume_selector {
                    margin: 0 8px;
                    flex: 1;
                    height: 100%;
                }

                #ch_status {
                    display: flex;
                    justify-content: flex-start;
                    align-items: flex-start;
                }

                #ch_status div {
                    position: absolute;
                    top: 10px;
                    left: 10px;
                    height: calc(90% - 10px);
                    width: 70%;
                    display: grid;
                    grid-template-columns: 20% 20% 20%;
                    column-gap: 5%;
                    align-content: space-evenly;
                    justify-content: center;
                    align-items: center;
                }

                #ch_status span {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    background-color: var(--screen-text);
                    color: var(--screen-color);
                    border-radius: 4px;
                    aspect-ratio: 2/1;
                    cursor: pointer;
                }


        #btn_off {
            -webkit-app-region: no-drag;
            position: absolute;
            background-color: #d52424;
            box-shadow: #000 0 0 5px;
            aspect-ratio: 3/2;
            height: 15%;
            bottom: 5%;
            left: 5%;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #FFF;
            font-weight: bold;
        }

        #ll_logo {
            position: absolute;
            bottom: 5%;
            left: 50%;
            transform: translateX(-50%);
            height: 15%;
            align-self: center;
            filter: brightness(0%);
        }

        #pager {
            -webkit-app-region: drag;
            position: absolute;
            height: 100%;
            width: 100%;
            top: 0;
            left: 0;
            /*border-radius: 20px;*/
            background-color: #444;
        }

        /*ANIMATIONS*/

        .urgentLstCall {
            animation: urgentLstCallAnim 1.5s step-start infinite;    
        }

        @keyframes urgentLstCallAnim {
            50% {
                background-color: var(--screen-text);
                color: var(--screen-color);
            }
        }

        .textBlink {
            animation: textBlinkAnim 1.5s step-start infinite;
        }

        @keyframes textBlinkAnim {
            50% {opacity: 0;}
        }

    </style>
</head>
<body>

    <div id="pager">

    </div>

    <div id="screen">

        <span id="lst_call">
            <span id="lst_call_img"class="material-symbols-outlined">e911_avatar</span>
            <span id="lst_call_msg">LST-RUF WICHTIG!</span>
        </span>


        <span id="job_info">
            <span class="jobTransInfo" id="job_download">
                <span class="material-symbols-outlined">sync</span>
                <span>Empfange Einsatzdaten...</span>
            </span>
            <span class="jobTransInfo" id="job_download_fail">
                <span class="material-symbols-outlined">sync_problem</span>
                <span>Einsatzdaten konnten nicht empfangen werden!</span>
            </span>
            <span class="jobInfo" data-job="title"></span>
            <span class="jobInfo" data-job="location"></span>
            <span class="jobInfo" data-job="caller"></span>
            <span class="jobInfo" data-job="comment"></span>
        </span>



        <!-- Settings Divs -->

        <div class="ch_div" id="ch_status">
            <div>
                <span onclick="sendStatus(1)">1</span>
                <span onclick="sendStatus(2)">2</span>
                <span onclick="sendStatus(3)">3</span>
                <span onclick="sendStatus(4)">4</span>
                <span onclick="sendStatus(5)">5</span>
                <span onclick="sendStatus(6)">6</span>
                <span onclick="sendStatus(7)">7</span>
                <span onclick="sendStatus(8)">8</span>
                <span onclick="sendStatus(9)">9</span>
            </div>
        </div>

        <div class="ch_div" id="ch_connection">
            connection
        </div>

        <div class="ch_div" id="ch_sound">
            <div>
                <span class="ch_header">Sound</span>
                <div class="soundOption">
                    <span class="material-symbols-outlined">volume_up</span>
                    <span class="ch_selection" id="volume_selector" onclick="setVolumeInput(event)">
                        <span data-volume="0" class="ch_selection_start"></span>
                        <span data-volume="1" class="ch_selection_small"></span>
                        <span data-volume="2" class="ch_selection_medium"></span>
                        <span data-volume="3" class="ch_selection_small"></span>
                        <span data-volume="4" class="ch_selection_medium"></span>
                        <span data-volume="5" class="ch_selection_small"></span>
                        <span data-volume="6" class="ch_selection_end"></span>
                    </span>
                </div>
            </div>
        </div>

        <div class="ch_div" id="ch_display">
            <div>
                <span class="ch_header">Display</span>
                <div class="displayOption">
                    <span class="material-symbols-outlined">texture</span>
                    <span class="ch_selection" id="opacity_selector" onclick="setOpacityInput(event)">
                        <span data-opacity="0" class="ch_selection_start"></span>
                        <span data-opacity="1" class="ch_selection_small"></span>
                        <span data-opacity="2" class="ch_selection_medium"></span>
                        <span data-opacity="3" class="ch_selection_small"></span>
                        <span data-opacity="4" class="ch_selection_medium"></span>
                        <span data-opacity="5" class="ch_selection_small"></span>
                        <span data-opacity="6" class="ch_selection_end"></span>
                    </span>
                </div>
                <div class="displayOption">
                    <span class="material-symbols-outlined">contrast</span>
                    <span class="ch_selection" id="contrast_selector" onclick="setContrastInput(event)">
                        <span data-contrast="0" class="ch_selection_start"></span>
                        <span data-contrast="1" class="ch_selection_small"></span>
                        <span data-contrast="2" class="ch_selection_medium"></span>
                        <span data-contrast="3" class="ch_selection_small"></span>
                        <span data-contrast="4" class="ch_selection_end"></span>
                    </span>
                </div>
            </div>
        </div>

        <div class="ch_div" id="ch_settings">
            settings
        </div>



        <div id="status_bar">
            <span id="connection" onclick="btnPress('connection')" class="material-symbols-outlined">signal_cellular_nodata</span>
            <span id="sound" onclick="btnPress('sound')" class="material-symbols-outlined">volume_off</span>
            <span id="display" onclick="btnPress('display')" class="material-symbols-outlined">contrast</span>
            <span id="settings" onclick="btnPress('settings')" class="material-symbols-outlined">settings</span>
            <span id="sync" onclick="requestSync()" class="material-symbols-outlined">sync</span>
            <span id="unit_display"></span>
        </div>

        <div id="status_btn" onclick="btnPress('status')">
            <span id="status_nmbr">6</span>
        </div>


    </div>

    <span id="btn_off" onclick="btnOff()" class="material-symbols-outlined">mode_off_on</span>

    <img id="ll_logo" src="../src/ll_logo.ico">

    <script>
        const jobInfo = document.querySelector("#job_info");
        let openWindow;
        let connected = false;
        let syncCooldown = false;
        let settings = new Object();

        /* --- Pager Init --- */

        function initPager() {
            closeSettings();
            window.electronAPI.pagerSettings(["get","pager_s_touchscreen"]);
        }
        function loadSettings(newSettings) {
            console.log(newSettings)

            if(newSettings) {//apply saved options
                setOpacity(newSettings.opacity);
                setContrast(newSettings.contrast);
                setVolume(newSettings.volume);
            }
            else {//apply standard options
                setOpacity(6);
                setContrast(3);
                setVolume(1);
            }

        }

        /* --- Settings --- */

        function setOpacityInput(event) {
            let opacityTarget = event.target.dataset.opacity;

            //return if no valid option is clicked
            if(!opacityTarget)
                return;

            //set opacity
            setOpacity(opacityTarget);
        }
        function setOpacity(newOpacity) {
            let opacitySettings = [
                0.2,
                0.3,
                0.4,
                0.5,
                0.6,
                0.8,
                1
            ];
            console.log("new opacity",newOpacity)

            //return if old value is selected
            if(settings.opacity == newOpacity)
                return;

            //remove all selection indicators
            document.querySelectorAll("#opacity_selector .ch_selection_active").forEach((el)=>{el.classList.remove("ch_selection_active")});

            //add selection indicator
            document.querySelector(`#opacity_selector span[data-opacity="${newOpacity}"]`).classList.add("ch_selection_active");

            //change opacity via main process
            window.electronAPI.pagerSettings(["opacity",opacitySettings[newOpacity]]);

            //only save settings if settings were already initialized
            if(settings.opacity) {
                settings.opacity = newOpacity;
                window.electronAPI.pagerSettings(["set",["pager_s_touchscreen",settings]]);
            }
            else
                settings.opacity = newOpacity;
        }

        function setContrastInput(event) {
            let contrastTarget = event.target.dataset.contrast;

            //return if no valid option is clicked
            if(!contrastTarget)
                return;

            //set contrast
            setContrast(contrastTarget);
        }
        function setContrast(newContrast) {
            let contrastSettings = [
                ["#98b3a5","#404040"],
                ["#b3ccbf","#333333"],
                ["#c0d8cc","#262626"],
                ["#D9E9DF","#1F1F1F"],
                ["#dfece4","#0d0d0d"]
            ];
            console.log("new contrast",newContrast)

            //return if old value is selected
            if(settings.contrast == newContrast)
                return;


            //remove all selection indicators
            document.querySelectorAll("#contrast_selector .ch_selection_active").forEach((el)=>{el.classList.remove("ch_selection_active")});

            //add selection indicator
            document.querySelector(`#contrast_selector span[data-contrast="${newContrast}"]`).classList.add("ch_selection_active");

            //change contrast via css variables
            document.documentElement.style.cssText = `
            --screen-color: ${contrastSettings[newContrast][0]};
            --screen-text: ${contrastSettings[newContrast][1]};
            `;

            //only save settings if settings were already initialized
            if(settings.contrast) {
                settings.contrast = newContrast;
                window.electronAPI.pagerSettings(["set",["pager_s_touchscreen",settings]]);
            }
            else
                settings.contrast = newContrast;
        }

        function setVolumeInput(event) {
            let volumeTarget = event.target.dataset.volume;

            //return if no valid option is clicked
            if(!volumeTarget)
                return;

            //set volume
            setVolume(volumeTarget);
        }
        function setVolume(newVolume) {
            let volumeSettings = [
                [0,"notifications_off"],
                [0.05,"notifications"],
                [0.1,"notifications"],
                [0.15,"notifications"],
                [0.2,"notifications_active"],
                [0.4,"notifications_active"],
                [0.6,"notifications_active"]
            ];
            console.log("new volume",newVolume)

            //return if old value is selected
            if(settings.volume == newVolume)
                return;


            //remove all selection indicators
            document.querySelectorAll("#volume_selector .ch_selection_active").forEach((el)=>{el.classList.remove("ch_selection_active")});

            //add selection indicator
            document.querySelector(`#volume_selector span[data-volume="${newVolume}"]`).classList.add("ch_selection_active");

            //change volume, volume indicators
            document.querySelector("#audio").volume = volumeSettings[newVolume][0];
            document.querySelector("#sound").innerText = volumeSettings[newVolume][1];
            

            //only save settings if settings were already initialized
            if(settings.volume) {
                settings.volume = newVolume;
                window.electronAPI.pagerSettings(["set",["pager_s_touchscreen",settings]]);
                playSound("beep");//preview sound
            }
            else
                settings.volume = newVolume;
        }

        /* --- Misc & UI --- */

        function closeSettings() {
            let windows = document.querySelectorAll(".ch_div");

            for(let i=0, iLength=windows.length; i<iLength; i++) {
                windows[i].style.display = "none";
            }
            openWindow = null;
        }

        function openSettings(setting) {
            document.querySelector(`#ch_${setting}`).style.display = "flex";
            openWindow = setting;
        }

        function sendMsg() {
            window.electronAPI.sendMsg("test");
        }

        function btnOff() {
            window.close();
        }

        function btnPress(btn) {
            if(openWindow == btn) // öffnet fenster oder schließt Fenster wenn schon offen
                closeSettings();
            else {
                closeSettings();
                openSettings(btn);
            }
        }

        function requestSync() {
            if(!syncCooldown) {
                syncCooldown = true;
                document.querySelector("#sync").classList.add("textBlink");
                syncPager();

                setTimeout(()=>{
                    document.querySelector("#sync").classList.remove("textBlink");
                    syncCooldown = false;
                }, 10000);
            }
        }

        /* --- Communication --- */

        function connectionUpdate(new_connected) {
            if(new_connected) {
                document.querySelector("#unit_display").innerText = userAuth.unit;
                document.querySelector("#connection").innerText = "signal_cellular_3_bar";
                document.querySelector("#connection").classList.remove("textBlink");
            }
            else {
                document.querySelector("#connection").innerText = "signal_cellular_nodata";
                document.querySelector("#connection").classList.add("textBlink");
            }
        }

        function statusUpdate(new_status) {
            document.querySelector("#status_nmbr").innerText = new_status;
        }

        async function jobUpdate(new_job_id) {

            //clear previous job
            document.querySelector("span[data-job=title]").innerText = "";
            document.querySelector("span[data-job=location]").innerText = "";
            document.querySelector("span[data-job=caller]").innerText = "";
            document.querySelector("span[data-job=comment]").innerText = "";

            //cancel job update if unit has no assigned job
            if(new_job_id == false)
                return;

            //display wait message, remove error message if needed
            document.querySelector("#job_download_fail").style.display = "none";
            document.querySelector("#job_download").style.display = "flex";


            let response = await fetch(`https://limnos.kreisi.net/getjobinfo?id=${new_job_id}&faction=${userAuth.faction}&user_ident=${encodeURIComponent(userAuth.user_ident)}&user_key=${encodeURIComponent(userAuth.user_key)}`);
            console.log(response)
            if(response.status == 200) {
                document.querySelector("#job_download").style.display = "none";
            }
            else {//display error message when job info cannot be obtained
                document.querySelector("#job_download").style.display = "none";
                document.querySelector("#job_download_fail").style.display = "flex";
                return;
            }
            let new_job = await response.json();
            console.log(new_job)

            //set new job info if available
            if(new_job.title) {
                document.querySelector("span[data-job=title]").innerText = new_job.title;
            }
            if(new_job.location) {
                document.querySelector("span[data-job=location]").innerHTML = `<span class="material-symbols-outlined">location_on</span> ${makeSafe(new_job.location)}`;
            }
            if(new_job.caller) {
                document.querySelector("span[data-job=caller]").innerHTML = `<span class="material-symbols-outlined">call</span> ${makeSafe(new_job.caller)}`;
            }
            if(new_job.msg) {
                document.querySelector("span[data-job=comment]").innerHTML = `<span class="material-symbols-outlined">notes</span> ${makeSafe(new_job.msg)}`;
            }
        }

        function lstCall(urgent) {

            //cancel call if another is already active
            if(document.querySelector("#lst_call").style.display == "flex")
                return;

            let warningLength;

            //show warning popup
            if(urgent) {
                document.querySelector("#lst_call").classList.add("urgentLstCall");
                document.querySelector("#lst_call_img").innerText = "e911_avatar";
                document.querySelector("#lst_call_msg").innerText = "LST-RUF WICHTIG!";
                warningLength = 11000;
                playSound("lst_call_urgent");
            }
            else {
                document.querySelector("#lst_call_img").classList.add("textBlink");
                document.querySelector("#lst_call_img").innerText = "call";
                document.querySelector("#lst_call_msg").innerText = "LST-RUF";
                warningLength = 5000;
                playSound("lst_call");
            }
            document.querySelector("#lst_call").style.display = "flex";

            //remove warning after set time
            setTimeout(()=>{
                document.querySelector("#lst_call").style.display = "none";
                document.querySelector("#lst_call").classList.remove("urgentLstCall");
                document.querySelector("#lst_call_img").classList.remove("textBlink");
            }, warningLength);
        }

        /* --- Sound --- */

        function playSound(soundName) {
            let soundLocations = {
                "lst_call" : "../src/lst_call.mp3",
                "lst_call_urgent" : "../src/lst_call_urgent.mp3",
                "beep" : "../src/beep.mp3"
            }
            let audioEl = document.querySelector("#audio");

            audioEl.src = soundLocations[soundName];
            audioEl.play();
        }
    </script>
    <script src="../src/socket_handler.js"></script>
    <script src="../src/x_xxs.js"></script>
    <audio id="audio"></audio>
</body>

</html>