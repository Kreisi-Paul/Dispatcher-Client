<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Test</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link href="../src/variables.css" rel="stylesheet">
    <style>
        html {
            width: 100%;
            height: 100%;
            background: transparent;
            overflow: hidden;
            --ui-dark: #222;
            --ui-light: #444;
        }

        body {
            position: absolute;
            top: 0;
            left: 0;
            margin: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }

        * {
            user-select: none;
            font-family: Verdana, Geneva, Tahoma, sans-serif;
        }

        *::selection {
            background-color: #bbb;
        }

        .material-symbols-outlined {
            user-select: none !important;
        }

        #tablet {
            height: 100%;
            width: 100%;
            /* background-color: #222; */
            background-color: #333;
            box-shadow: #00000044 0 0 10px inset;
            -webkit-app-region: drag;
        }

        #screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1;
            background-color: #000;
            border-radius: 10px;
            height: calc(100% - 40px);
            width: calc(100% - 40px);
            overflow: hidden;
            -webkit-app-region: no-drag;
        }

        /* GENERAL DIVS */
        
        #screen > div {
            position: absolute;
            height: 100%;
            width: 100%;
        }



        #lockscreen {
            z-index: 5;
            background: linear-gradient(45deg, #926161 20%, #c54f4f 80%);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

            #lockscreen_logo {
                position: absolute;
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100%;
                font-size: 70vh;
                color: #00000022;
            }



        #navbuttons {
            z-index: 4;
            right: -40px;
            height: 100% !important;
            width: 80px !important;
        }

            #navbuttons > div {
                position: relative;
                height: 100%;
                width: 40px;
                background: #00000066;
                transform: translateX(100%);
                transition: transform 200ms ease-in-out;
                display: flex;
                flex-direction: column;
                justify-content: space-evenly;
                align-items: center;
            }

            #navbuttons:hover > div {
                transform: translateX(0%);
            }

            #navbuttons > div > span {
                width: 30px;
                color: #fff;
                cursor: pointer;
                aspect-ratio: 1/2;
                border-radius: 15px;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            #navbuttons > div > span:hover {
                background-color: #ffffff44;
            }

            #navbuttons > div > span:active {
                background-color: #ffffff66;
                transition: background-color 50ms ease-in-out;
            }

            .sosBtnReady {
                background-color: #ff000088 !important;
            }



        #statusbar {
            z-index: 3;
        }

            #status_info {
                z-index: inherit;
                position: absolute;
                padding: 4px 10px;
                display: flex;
                gap: 6px;
                border-bottom-right-radius: 0.5em;
                background: #00000066;
            }

            #status_info span, #status_notifications span {
                color: #fff;
                font-size: 16px;
            }

            #status_notifications {
                z-index: inherit;
                position: absolute;
                top: 0;
                left: 50%;
                transform: translateX(-50%);
                min-width: 2em;
                padding: 0 10px;
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 6px;
                border-bottom-right-radius: 0.5em;
                border-bottom-left-radius: 0.5em;
                background: #00000066;
                cursor: pointer;
            }

            #status_notifications span {
                margin: 4px 0;
            }

            #notification_tray {
                z-index: inherit;
                position: absolute;
                height: calc(100% - 40px);
                width: 100%;
                padding: 20px 0;
                background: #00000066;
                backdrop-filter: blur(5px);
                display: none;
                flex-direction: column;
                justify-content: flex-start;
                align-items: center;
                gap: 20px;
                overflow-y: scroll;
            }

            #notification_tray > div {
                background: #00000044;
                border: #444 1px solid;
                color: #fff;
                padding: 10px;
                width: 35%;
                border-radius: 10px;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                gap: 4px;
                backdrop-filter: blur(10px);
            }

            .notificationDelete {
                position: absolute;
                right: 10px;
                cursor: pointer;
            }

            .notificationInfo {
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .notificationIcon {
                font-size: 16px;
                padding: 4px;
                border-radius: 0.6ch;
            }

            .notificationInfo p {
                margin: 0;
            }

            .notificationContent {
                flex: 1;
                display: flex;
                text-wrap: wrap;
                overflow-wrap: break-word;
                user-select: text;
            }

            .notificationContent * {
                user-select: text;
            }

            .notificationTime {
                align-self: flex-end;
                font-size: 12px;
            }

            #active_notification {
                z-index: inherit;
                position: absolute;
                left: 50%;
                top: -100px;
                transform: translateX(-50%);
                min-width: 20%;
                max-width: 35%;
                padding: 8px;
                border-radius: 10px;
                border: #444 1px solid;
                color: #fff;
                background-color: #00000088;
                backdrop-filter: blur(10px);
                display: flex;
                flex-direction: column;
                gap: 4px;
            }

            #active_notification .notificationInfo {
                align-self: center;
            }

            #active_notification.active {
                animation: notificationSlide 8s;
            }

            @keyframes notificationSlide {
                0% {top: -100px;}
                10%, 90% {top: 10px;}
                100% {top: -100px;}
            }

            #active_apps {
                z-index: inherit;
                position: absolute;
                height: calc(100% - 40px);
                width: calc(100% - 40px);
                padding: 20px;
                background: #00000066;
                backdrop-filter: blur(5px);
                display: none;
                flex-direction: column;
                align-items: stretch;
            }

            #active_apps_options {
                border-radius: 50ch;
                border: #444 1px solid;
                background: #00000044;
                color: #fff;
                backdrop-filter: blur(10px);
                padding: 4px 6px;
                position: absolute;
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 2px;
            }

            #active_apps_options > span {
                font-size: 18px;
                padding: 4px;
                border-radius: 50ch;
                aspect-ratio: 1/1;
                display: flex;
                cursor: pointer;
            }

            #active_apps_options > span:hover {
                background-color: #ffffff44;
            }

            #active_apps_list {
                pointer-events: none;
                flex: 1;
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 20px;
            }

            .activeApp {
                pointer-events: all;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 2px;
            }

            .activeAppActions {
                display: flex;
                margin-bottom: 4px;
                transform: translateY(100%);
                padding: 2px 4px;
                opacity: 0;
                background-color: #00000044;
                backdrop-filter: blur(5px);
                border-radius: 50ch;
                border: #444 1px solid;
                color: #fff;
                transition: all ease-in-out 200ms;
                cursor: pointer;
            }

            .activeApp:hover .activeAppActions {
                transform: translateY(0);
                opacity: 1;
            }

            .activeAppActions span {
                border-radius: 50ch;
                padding: 2px;
            }

            .activeAppActions span:hover {
                background-color: #ffffff44;
            }



        #apps {
            z-index: 2;
            pointer-events: none;
            display: flex;
            flex-direction: row;
        }

            .app {
                display: none;
                pointer-events: all;
            }

            .app.appFullscreen {
                display: flex;
                background-color: #f00;
                position: absolute;
                top: 0;
                left: 0;
                height: 100%;
                width: 100%;
            }

            .app.appLeft {
                background-color: #0f0;
            }

            .app.appRight {
                background-color: #00f;
            }

            .app[data-app="status"] {
                background-color: var(--ui-dark);
                flex-direction: column;
                justify-content: center;
                align-items: center;
                gap: 3vw;
            }

                #status_active {
                    width: 30%;
                    min-width: 150px;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    color: #fff;
                    font-weight: bold;
                    box-shadow: #00000066 0 0 30px inset;
                    padding: 10px 0;
                    border-radius: 5px;
                    gap: 6px;
                }

                #status_buttons {
                    width: 30%;
                    min-width: 150px;
                    display: grid;
                    grid-template-columns: auto auto auto;
                    grid-template-rows: auto auto auto;
                    gap: 1vw;
                }

                #status_buttons span {
                    font-size: 3vw;
                    padding: 2vw;
                    aspect-ratio: 1/1;
                    background-color: #00f;
                    border-radius: 5px;
                    color: #fff;
                    box-shadow: #00000066 0 0 30px inset;
                    cursor: pointer;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                }

                #status_buttons span:hover {
                    filter: saturate(120%) brightness(110%) drop-shadow(#000 0 0 10px);
                }

                #status_buttons span[data-status="1"],
                #status_buttons span[data-status="2"] {
                    background-color: var(--status-green);
                }
                #status_buttons span[data-status="3"] {
                    background-color: var(--status-yellow);
                }
                #status_buttons span[data-status="4"],
                #status_buttons span[data-status="6"] {
                    background-color: var(--status-red);
                }
                #status_buttons span[data-status="5"] {
                    background-color: var(--status-blue);
                }
                #status_buttons span[data-status="7"],
                #status_buttons span[data-status="8"] {
                    background-color: var(--status-orange);
                }
                #status_buttons span[data-status="9"] {
                    background: linear-gradient(45deg, var(--status-orange) 10%, var(--status-red) 90%);
                }

            .app[data-app="alarm"] {
                background-color: var(--ui-dark);
                color: #fff;
                padding: 20px;
                height: calc(100% - 40px);
                width: calc(100% - 40px);
                gap: 20px;
            }

                .app[data-app="alarm"] > div {
                    display: flex;
                    flex-direction: column;
                    gap: 20px;
                }

                .app[data-app="alarm"] > div:nth-child(1) {
                    width: 60%;
                }

                .app[data-app="alarm"] > div:nth-child(2) {
                    width: 40%;
                }

                .app[data-app="alarm"] > div > div{
                    box-shadow: var(--ui-light) 0 0 0 2px inset;
                    padding: 6px;
                }

                #job_info {
                    display: flex;
                    flex-direction: column;
                    justify-content: flex-start;
                    align-items: stretch;
                    gap: 6px;
                }

                #job_info span[data-job="title"] {
                    font-size: 22px;
                    text-align: center;
                    margin-bottom: 1em;
                    display: flex;
                    justify-content: center;
                    align-items: flex-end;
                    gap: 8px;
                    text-wrap: wrap;
                    word-wrap: break-word;
                    word-break: break-all;
                    user-select: text;
                }

                #job_info span[data-job="title"] > b {
                    font-size: 28px;
                    text-wrap: nowrap;
                }

                #job_info > div {
                    display: flex;
                    justify-content: flex-start;
                    align-items: center;
                    gap: 2px;
                }
                
                #job_info > div * {
                    text-wrap: wrap;
                    word-wrap: break-word;
                    word-break: break-all;
                    font-size: 16px;
                    user-select: text;
                }

                #job_units {
                    flex: 1;
                    overflow: hidden;
                }
                
                #job_units p {
                    margin: 0;
                    font-size: 22px;
                    text-align: center;
                }

                #job_units > div {
                    display: flex;
                    flex-direction: column;
                    gap: 5px;
                    overflow-y: scroll;
                }

                #job_time {
                    display: flex;
                    flex-direction: column;
                    justify-content: flex-start;
                    align-items: center;
                }

                #job_time p {
                    font-size: 22px;
                    margin: 0;
                }

                #job_time span {
                    font-size: 28px;
                    font-weight: bold;
                }

                #job_map {
                    flex: 3;
                }

            .app[data-app="messages"] {
                background-color: var(--ui-dark);
                height: 100%;
                width: 100%;
                flex-direction: column;
                flex-wrap: wrap;
            }

            #messages_mainmenu {
                z-index: 1;
                width: calc(80% - 40px);
                padding: 0 20px;
                height: 46px;
                background: linear-gradient(45deg, rgb(76, 218, 29) 20%, rgb(57, 108, 33) 80%);
                box-shadow: #00000088 0 0 10px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            #messages_mainmenu p {
                margin: 0;
                font-weight: bold;
                font-size: 20px;
            }

            #messages_contacts {
                z-index: 2;
                width: 20%;
                height: 100%;
                padding-top: 46px;
                background-color: var(--ui-dark);
                box-shadow: #000 0 0 10px;
                overflow-y: scroll;
            }

            #messages_contacts hr {
                margin: 0;
                border: #ffffff44 1px solid;
            }

            #messages_contacts > span {
                display: flex;
                justify-content: flex-start;
                align-items: center;
                gap: 2px;
                padding: 2px 6px;
                color: #fff;
                cursor: pointer;
            }

            #messages_contacts > span:hover {
                backdrop-filter: brightness(140%);
            }

            .unreadMessage.unread {
                background-color: rgb(76, 218, 29);
                border-radius: 50ch;
                height: 0.5em;
                aspect-ratio: 1/1;
                display: flex;
                transform: translateY(-0.5ch);
            }

            #messages_content {
                position: absolute;
                bottom: 0;
                right: 0;
                flex: 1;
                height: 90%;
                width: 80%;
                background-color: var(--ui-light);
                display: flex;
                flex-direction: column;
                align-items: stretch;
            }

            #messages_input {
                position: absolute;
                bottom: 0;
                width: 50%;
                height: 34px;
                padding: 0 18px;
                margin-bottom: 20px;
                margin-left: 20px;
                border-radius: 50ch;
                background-color: #fff;
                box-shadow: #000 0 0 5px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 10px;
            }

            #messages_input input {
                all: unset;
                flex: 1;
            }

            #messages_input span {
                border-radius: 50ch;
                padding: 4px;
                font-size: 22px;
                cursor: pointer;
            }

            #messages_input span:hover {
                background-color: #00000044;
            }

            #messages_chat {
                flex: 1;
                display: flex;
                flex-direction: column;
                padding: 20px;
                padding-bottom: calc(40px + 34px);
                gap: 6px;
                overflow-y: scroll;
            }

            .messageBubble {
                box-shadow: #00000088 0 0 5px;
                display: flex;
                flex-direction: column;
                max-width: 45%;
                padding: 10px;
                border-radius: 15px;
            }

            .messageBubble.sent {
                background: rgb(76, 218, 29);
                align-self: flex-end;
                border-bottom-right-radius: 0;
            }

            .messageBubble.recieved {
                background: #fff;
                align-self: flex-start;
                border-bottom-left-radius: 0;
            }

            .messageContent {
                text-align: left;
                user-select: text;
                overflow-wrap: break-word;
            }

            .messageTimestamp {
                font-size: 10px;
                text-align: right;
            }




        #desktop {
            z-index: 1;
            background-image: url(../src/background.png);
            background-size: cover;
            background-position: center;
            display: grid;
            grid-template-columns: repeat(auto-fill, 80px);
            justify-content: center;
            align-content: flex-start;
            gap: 40px;
            padding: 20px;
            height: calc(100% - 40px) !important;
            width: calc(100% - 40px) !important;
        }

            .appButton {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                width: 80px;
                gap: 6px;
                aspect-ratio: 3/4;
                transition: filter 200ms ease-in-out;
            }

            .appButton:hover {
                filter: drop-shadow(#000 0 0 5px);
            }

            .appButton:hover .appIcon {
                filter: brightness(120%);
            }

            .appIcon {
                height: 60px;
                aspect-ratio: 1/1;
                border-radius: 0.6ch;
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 36px;
                font-weight: 400;
                cursor: pointer;
                transition: filter 200ms ease-in-out;
            }

            .appName {
                color: #fff;
            }

            /* APP ICONS */

            .appButton[data-app=alarm] .appIcon,
            .notificationIcon[data-app=alarm],
            .activeApp[data-app=alarm] .appIcon {
                background: linear-gradient(45deg, rgb(204, 29, 29) 20%, rgb(255, 132, 17) 80%);
                color: #fff;
            }

            .appButton[data-app=maps] .appIcon,
            .notificationIcon[data-app=maps],
            .activeApp[data-app=maps] .appIcon {
                background: linear-gradient(45deg, rgb(145, 100, 44) 20%, rgb(46, 46, 46) 80%);
                color: #fff;
            }

            .appButton[data-app=status] .appIcon,
            .notificationIcon[data-app=status],
            .activeApp[data-app=status] .appIcon {
                background: linear-gradient(45deg, rgb(105, 210, 215) 20%, rgb(129, 53, 146) 80%);
                color: #fff;
            }

            .appButton[data-app=follow_up] .appIcon,
            .notificationIcon[data-app=follow_up],
            .activeApp[data-app=follow_up] .appIcon {
                background: linear-gradient(45deg, rgb(13, 71, 206) 20%, rgb(209, 26, 26) 80%);
                color: #fff;
            }

            .appButton[data-app=messages] .appIcon,
            .notificationIcon[data-app=messages],
            .activeApp[data-app=messages] .appIcon {
                background: linear-gradient(45deg, rgb(76, 218, 29) 20%, rgb(57, 108, 33) 80%);
                color: #fff;
            }

            .appButton[data-app=status_5] .appIcon {
                background: linear-gradient(45deg, var(--status-blue) 20%, rgb(52, 52, 52) 90%);
                color: #fff;
            }

            .appButton[data-app=settings] .appIcon,
            .notificationIcon[data-app=settings],
            .activeApp[data-app=settings] .appIcon {
                background: linear-gradient(45deg, rgb(51, 51, 51), rgb(172, 172, 172) 80%);
                color: #fff;
            }


        /* STATUS BACKGROUNDS*/
        .status1 {
            background-color: var(--status-green);
        }
        .status2 {
            background-color: var(--status-green);
        }
        .status3 {
            background-color: var(--status-yellow);
        }
        .status4 {
            background-color: var(--status-red);
        }
        .status5 {
            background-color: var(--status-blue);
        }
        .status6 {
            background-color: var(--status-red);
        }
        .status7 {
            background-color: var(--status-orange);
        }
        .status8 {
            background-color: var(--status-orange);
        }
        .status9 {
            background-color: var(--status-red);
            box-shadow: var(--status-orange) 0 0 10px;
            animation: distress 1.6s step-start infinite;
        }
        @keyframes distress {
            50% {
                background-color: var(--status-orange);
                box-shadow: var(--status-red) 0 0 10px;
            }
        }

    </style>
</head>
<body>
    <div id="tablet"></div>
    <div id="screen">
        <span id="statusbar">
            <div id="status_info">
                <span class="material-symbols-outlined">battery_horiz_075</span>
                <span id="status_connection" class="material-symbols-outlined">signal_cellular_nodata</span>
                <span id="status_sound" class="material-symbols-outlined">notifications_off</span>
            </div>
            <div id="status_notifications" onclick="openNotificationTray()"></div>
            <div id="notification_tray" onclick="event.target == this ? closeNotificationTray() : null"></div>
            <div id="active_notification"></div>
            <div id="active_apps" onclick="event.target == this ? closeAppManagement() : null">
                <div id="active_apps_options">
                    <span class="material-symbols-outlined" onclick="openApp('apps',{'category':'apps'})">settings</span>
                    <span class="material-symbols-outlined">power_settings_new</span>
                </div>
                <div id="active_apps_list">
                </div>
            </div>
        </span>



        <div id="lockscreen">
            <div id="lockscreen_welcome">
                <span>Hallo, </span>
                <span>Max Mustermann</span>
            </div>
            <div>
                <span class="material-symbols-outlined">lock</span>
            </div>
            <span id="lockscreen_logo" class="material-symbols-outlined">medical_services</span>
        </div>



        <div id="navbuttons">
            <div>
                <span class="material-symbols-outlined" onclick="navButton('splitscreen')">splitscreen_left</span>
                <span class="material-symbols-outlined" onclick="navButton('back')">arrow_back_ios_new</span>
                <span class="material-symbols-outlined" onclick="navButton('home')">crop_square</span>
                <span class="material-symbols-outlined" onclick="navButton('menu')">menu</span>
                <span id="sos_btn" class="material-symbols-outlined" onmousedown="triggerSOS()" onmouseleave="sendSOS(false)" onmouseup="sendSOS(true)">emergency</span>
            </div>
        </div>



        <div id="apps">
            <div class="app" data-app="alarm">
                <div>
                    <div id="job_info">
                        <span data-job="title"></span>
                        <div>
                            <span class="material-symbols-outlined">location_on</span>
                            <span data-job="location"></span>
                        </div>
                        <div>
                            <span class="material-symbols-outlined">call</span>
                            <span data-job="caller"></span>
                        </div>
                        <div>
                            <span class="material-symbols-outlined">notes</span>
                            <span data-job="comment"></span>
                        </div>
                    </div>
                    <div id="job_units">
                        <p>Einsatzkräfte:</p>
                        <div data-job="units">

                        </div>
                    </div>
                </div>
                <div>
                    <div id="job_time">
                        <p>Alarmiert:</p>
                        <span data-job="timestamp"></span>
                    </div>
                    <div id="job_map">
                        WIP
                    </div>
                </div>
            </div>
            <div class="app" data-app="maps"></div>
            <div class="app" data-app="status">
                <div id="status_active">
                    <span id="unit_status"></span>
                    <span id="active_status"></span>
                </div>
                <div id="status_buttons">
                    <span data-status="1" onclick="sendStatus(1)">1</span>
                    <span data-status="2" onclick="sendStatus(2)">2</span>
                    <span data-status="3" onclick="sendStatus(3)">3</span>
                    <span data-status="4" onclick="sendStatus(4)">4</span>
                    <span data-status="5" onclick="sendStatus(5)">5</span>
                    <span data-status="6" onclick="sendStatus(6)">6</span>
                    <span data-status="7" onclick="sendStatus(7)">7</span>
                    <span data-status="8" onclick="sendStatus(8)">8</span>
                    <span data-status="9" onclick="sendStatus(9)">9</span>
                </div>
            </div>
            <div class="app" data-app="follow_up"></div>
            <div class="app" data-app="messages">
                <div id="messages_contacts"></div>
                <div id="messages_mainmenu">
                    <p></p>
                </div>
                <div id="messages_content">
                    <div id="messages_chat"></div>
                    <div id="messages_input">
                        <input placeholder="Nachricht schreiben..." onkeydown="event.key == 'Enter' ? sendChatMsg() : null" oninput="this.value.length > 100 ? this.value = this.value.slice(0,100) : null">
                        <span class="material-symbols-outlined" onclick="sendChatMsg()">send</span>
                    </div>
                </div>
            </div>
            <div class="app" data-app="settings"></div>
        </div>


        <div id="desktop">
            <span class="appButton" data-app="alarm">
                <span class="appIcon material-symbols-outlined" onclick="openApp(this.parentNode.dataset.app)">notifications_active</span>
                <span class="appName">Alarminfo</span>
            </span>
            <span class="appButton" data-app="maps">
                <span class="appIcon material-symbols-outlined" onclick="openApp(this.parentNode.dataset.app)">map</span>
                <span class="appName">Lagekarten</span>
            </span>
            <span class="appButton" data-app="status">
                <span class="appIcon material-symbols-outlined" onclick="openApp(this.parentNode.dataset.app)">cell_tower</span>
                <span class="appName">Status</span>
            </span>
            <span class="appButton" data-app="follow_up">
                <span class="appIcon material-symbols-outlined" onclick="openApp(this.parentNode.dataset.app)">e911_emergency</span>
                <span class="appName">Nachalarm</span>
            </span>
            <span class="appButton" data-app="messages">
                <span class="appIcon material-symbols-outlined" onclick="openApp(this.parentNode.dataset.app)">contact_emergency</span>
                <span class="appName">Nachrichten</span>
            </span>
            <span class="appButton" data-app="status_5">
                <span class="appIcon material-symbols-outlined" onclick="sendStatus(5)">call_quality</span>
                <span class="appName">Status 5</span>
            </span>
            <span class="appButton" data-app="settings">
                <span class="appIcon material-symbols-outlined" onclick="openApp(this.parentNode.dataset.app)">settings</span>
                <span class="appName">Einstellungen</span>
            </span>
        </div>
    </div>


    <script>
        let soundset;
        let openApps = new Set();
        let pagerSettings = new Object();
        let activeJobId = false;
        let sosStatus = false;
        let notificationShown = false;
        const appInfo = {
            "alarm": {
                name: "Alarminfo",
                icon: "notifications_active"
            },
            "maps": {
                name: "Lagekarten",
                icon: "map"
            },
            "status": {
                name: "Status",
                icon: "cell_tower"
            },
            "follow_up": {
                name: "Nachalarm",
                icon: "e911_emergency"
            },
            "messages": {
                name: "Nachrichten",
                icon: "contact_emergency"
            },
            "settings": {
                name: "Einstellungen",
                icon: "settings"
            }
        };
        let appStorage = {
            "messages": {

            },
            "maps": {

            }
        };





        /* INIT */

        function initPager() {
            window.electronAPI.pagerSettings(["get","pager_l_touchscreen"]);
            window.electronAPI.getSettings();
        }
        function loadPagerSettings(newSettings) {
            console.log(newSettings)

            if(newSettings) {//apply saved options
                setOpacity(newSettings.opacity);
                setVolume(newSettings.volume);
            }
            else {//apply standard options
                setOpacity(6);
                setVolume(1);
            }
        }
        function loadSettings(newSettings) {
            soundset = newSettings.soundset;
        }


        /* SETTINGS */

        function setOpacity(newOpacity) {
            let opacitySettings = [
                0.2,
                0.3,
                0.4,
                0.5,
                0.6,
                0.8,
                1
            ];

            //return if old value is selected
            if(pagerSettings.opacity == newOpacity)
                return;

            //change opacity via main process
            window.electronAPI.pagerSettings(["opacity",opacitySettings[newOpacity]]);

            //only save settings if settings were already initialized
            if(pagerSettings.opacity) {
                pagerSettings.opacity = newOpacity;
                window.electronAPI.pagerSettings(["set",["pager_l_touchscreen",pagerSettings]]);
            }
            else
                pagerSettings.opacity = newOpacity;
        }

        function setVolume(newVolume) {
            let volumeSettings = [
                [0,"notifications_off"],
                [0.05,"notifications"],
                [0.1,"notifications"],
                [0.15,"notifications"],
                [0.2,"notifications_active"],
                [0.4,"notifications_active"],
                [0.6,"notifications_active"]
            ];
            console.log("new volume",newVolume)

            //return if old value is selected
            if(pagerSettings.volume == newVolume)
                return;

            //change volume, volume indicator
            document.querySelector("#audio").volume = volumeSettings[newVolume][0];
            document.querySelector("#status_sound").innerText = volumeSettings[newVolume][1];


            //only save settings if settings were already initialized
            if(pagerSettings.volume) {
                pagerSettings.volume = newVolume;
                window.electronAPI.pagerSettings(["set",["pager_l_touchscreen",pagerSettings]]);
                playSound("beep");//preview sound
            }
            else
                pagerSettings.volume = newVolume;
        }


        /* NAVBAR / STATUSBAR*/

        function navButton(button) {

            //general actions
            closeNotificationTray();
            closeAppManagement();

            //specific actions
            switch(button) {
                case "splitscreen":

                    break;
                case "back":
                
                    break;
                case "home":
                    document.querySelectorAll(".appFullscreen, .appLeft, .appRight").forEach((el)=>{el.classList.remove("appFullscreen","appLeft","appRight")});//closes every open app
                    break;
                case "menu":
                    openAppManagement();
                    break;
            }
        }

        function openNotificationTray() {
            document.querySelector("#notification_tray").style.display = "flex";
        }
        function closeNotificationTray() {
            document.querySelector("#notification_tray").style.display = "none";
        }

        function openAppManagement() {
            document.querySelector("#active_apps").style.display = "flex";
        }
        function closeAppManagement() {
            document.querySelector("#active_apps").style.display = "none";
        }

        /**
         * creates a notification for a specified app
         * @param {string} app appname
         * @param {string} content a **safe** string that shows up below the app name
         */
        function createNotification(app, content) {
            if(content.length > 40) {//limit content to 40 chars
                content = content.slice(0,36);
                content += "..."
            }

            let notificationEl = `
            <div>
                <span class="notificationDelete material-symbols-outlined" onclick="deleteNotification(this.parentNode)">close</span>
                    <span class="notificationInfo">
                        <span class="notificationIcon material-symbols-outlined" data-app="${app}">${appInfo[app].icon}</span>
                        <p>${appInfo[app].name}</p>
                    </span>
                    <span class="notificationContent">${content}</span>
                    <span class="notificationTime">${new Date(Date.now()).toLocaleTimeString("de",{hour:"2-digit",minute:"2-digit"})}</span>
            </div>`;

            if(!notificationShown) {
                notificationShown = true;
                let activeNotification = document.querySelector("#active_notification");

                activeNotification.innerHTML = `
                <span class="notificationInfo">
                    <span class="notificationIcon material-symbols-outlined" data-app="${app}">${appInfo[app].icon}</span>
                    <p>${appInfo[app].name}</p>
                </span>
                <span class="notificationContent">${content}</span>`;

                activeNotification.classList.add("active");

                setTimeout(()=>{
                    activeNotification.classList.remove("active");
                    activeNotification.innerHTML = "";
                    notificationShown = false;
                }, 8000);
            }

            if(!document.querySelector(`#status_notifications span[data-app="${app}"]`)) {//only add icon if none if "app" is already present
                document.querySelector("#status_notifications"). innerHTML += `<span data-app="${app}" class="material-symbols-outlined">${appInfo[app].icon}</span>`;
            }

            document.querySelector("#notification_tray").innerHTML += notificationEl;
        }

        function deleteNotification(el) {
            let app = el.children.item(1).children.item(0).dataset.app;
            el.remove();//remove notification

            if(!document.querySelector(`#notification_tray span[data-app="${app}"]`))//remove icon if no other notifications of app are present
                document.querySelector(`#status_notifications span[data-app="${app}"]`).remove();

            if(!document.querySelector(`#notification_tray div`))
                closeNotificationTray();
        }

        function triggerSOS() {
            sosStatus = null;
            setTimeout(()=>{
                if(sosStatus == null) {
                    document.querySelector("#sos_btn").classList.add("sosBtnReady");
                    sosStatus = true;
                }
            }, 2000);
        }

        function sendSOS(confirm) {
            if(sosStatus && confirm) {
                sendStatus(9);
            }
            sosStatus = false;
            document.querySelector("#sos_btn").classList.remove("sosBtnReady");
        }



        /* APP MANAGEMENT */

        function openApp(appName, data) {
            closeAppManagement()//close app management in case a shortcut from that menu was used
            //console.log(appName, data)


            try {//run app-specific code when it is not yet initialized
            if(!appStorage[appName].init) {
                switch(appName) {
                    case "messages":
                        fetch(`https://limnos.kreisi.net/getvehicles/${userAuth.faction}?user_ident=${encodeURIComponent(userAuth.user_ident)}&user_key=${encodeURIComponent(userAuth.user_key)}`).then(async(response)=>{
                            if(response.status != 200)
                                return;

                            let units = await response.json();
                            let contactEls = `
                            <span onclick="switchChat(this.children.item(1).innerText)">
                                <span class="material-symbols-outlined">cell_tower</span>
                                <p>Leitstelle</p>
                                <span class="unreadMessage unread"></span>
                            </span>
                            <hr>`;
                            appStorage.messages.chats = {"Leitstelle": [
                                ["sent","Das wurde gesendet","12:00"],
                                ["recieved","Ich habs gesehn","12:01"],
                                ["recieved","Ist gut","12:02"],
                                ["sent","Ne seh ich nicht so","12:03"]
                            ]};
                            appStorage.messages.init = true;

                            delete units[userAuth.unit];//delete own unit

                            for(let i=0,iLength=Object.keys(units).length; i<iLength; i++) {

                                appStorage.messages.chats[Object.keys(units)[i]] = [];

                                contactEls += `
                                <span onclick="switchChat(this.children.item(1).innerText)">
                                    <span class="material-symbols-outlined">minor_crash</span>
                                    <p>${makeSafe(Object.keys(units)[i])}</p>
                                    <span class="unreadMessage"></span>
                                </span>
                                `;
                                if(i+1 != iLength)
                                    contactEls += "<hr>";
                            }

                            document.querySelector("#messages_contacts").innerHTML = contactEls;
                        })
                        switchChat("");
                        break;
                }
            }
            } catch {}

            //show app
            document.querySelector(`#apps > div[data-app="${appName}"]`).classList.add("appFullscreen");

            //add app to active apps
            if(!openApps.has(appName)) {
                openApps.add(appName);
                document.querySelector("#active_apps_list").innerHTML += `
                <span class="activeApp" data-app="${appName}">
                    <span class="activeAppActions">
                        <span class="material-symbols-outlined" title="App schließen" onclick="closeApp('${appName}')">close</span>
                        <span class="material-symbols-outlined" title="Appinformationen">info</span>
                        <span class="material-symbols-outlined" title="In Spiltscreen-Modus öffnen">splitscreen_right</span>
                    </span>
                    <span class="appIcon material-symbols-outlined" onclick="openApp('${appName}')">${appInfo[appName].icon}</span>
                    <span class="appName">${appInfo[appName].name}</span>
                </span>`;
            }
        }

        function closeApp(appName) {
            //hide app
            document.querySelector(`#apps > div[data-app="${appName}"]`).classList.remove("appFullscreen","appLeft","appRight");

            //remove app from active apps
            openApps.delete(appName);
            document.querySelector(`#active_apps_list .activeApp[data-app="${appName}"]`).remove();

            //try to clear app storage
            try {
                appStorage[appName] = {};
            }
            catch {}
        }



        /* APPS */

        function switchChat(chat) {
            let chatDiv = document.querySelector("#messages_chat");
            chatDiv.innerHTML = "";
            let messagesEl = "";

            document.querySelector("#messages_input input").value = "";
            document.querySelector("#messages_mainmenu p").innerText = chat;

            for(let i=0,iLength=appStorage.messages.chats[chat].length; i<iLength; i++) {
                let tmpMessage = appStorage.messages.chats[chat][i];
                messagesEl += `
                <span class="messageBubble ${tmpMessage[0]}">
                <span class="messageContent">${makeSafe(tmpMessage[1])}</span>
                <span class="messageTimestamp">${tmpMessage[2]}</span>
                </span>`;
            }

            chatDiv.innerHTML = messagesEl;

            chatDiv.scrollTop = chatDiv.scrollHeight;//scroll to bottom
        }

        function sendChatMsg() {
            let input = document.querySelector("#messages_input input");
            let target = document.querySelector("#messages_mainmenu p").innerText;

            if(!input.value || !target)
                return;

            sendSocket({"msg":[target,input.value,userAuth.unit]});

            appStorage.messages.chats[target].push([//save sent message
                "sent",
                input.value,
                new Date(Date.now()).toLocaleTimeString("de",{hour:"2-digit",minute:"2-digit"})
            ]);
            
            switchChat(target);//refresh chat

            input.value = "";
        }

        function recieveChatMsg(message) {
            let newMsg = [
                "recieved",
                message[0],
                new Date(Date.now()).toLocaleTimeString("de",{hour:"2-digit",minute:"2-digit"})
            ];

            console.log(appStorage.messages.chats)
            appStorage.messages.chats[message[1]].push(newMsg);

            if(document.querySelector("#messages_mainmenu p").innerText == message[1])//update chat when user is currently looking at it
                switchChat(message[1]);

            if(document.querySelector(".app[data-app='messages']").classList.contains("appFullscreen")) {

            }
            else {
                createNotification("messages",`Nachricht von ${makeSafe(message[1])}: ${message[0]}`);
            }
        }









        /* COMMUNICATION */

        function connectionUpdate(connection) {
            if(connection) {
                document.querySelector("#status_connection").innerText = "signal_cellular_3_bar";
                document.querySelector("#unit_status").innerText = userAuth.unit;
            }
            else
                document.querySelector("#status_connection").innerText = "signal_cellular_nodata";
        }

        function statusUpdate(newStatus) {
            document.querySelector("#active_status").innerText = newStatus;
            document.querySelector("#status_active").classList = [`status${newStatus}`];
        }

        function jobUpdate(newJobId) {
            let jobUpdated; //for preventing new_call sound

            //clear previous job
            document.querySelector("span[data-job=title]").innerText = "--- / ---";
            document.querySelector("span[data-job=location]").innerText = "--- / ---";
            document.querySelector("span[data-job=caller]").innerText = "--- / ---";
            document.querySelector("span[data-job=comment]").innerText = "--- / ---";
            document.querySelector("span[data-job=timestamp]").innerText = "--- / ---";
            document.querySelector("div[data-job=units]").innerHTML = "";
            //play sound
            if(newJobId == false) {
                playSound("no_job");
            }
            else if(newJobId == activeJobId) {
                createNotification("alarm","Einsatzinformationen aktualisiert.")
                jobUpdated = true;
            }

            //update active job id
            activeJobId = newJobId;

            if(newJobId == false)
                return

            /*
            //display wait message, remove error message if needed
            document.querySelector("#job_download_fail").style.display = "none";
            document.querySelector("#job_download").style.display = "flex";
            */

            fetch(`https://limnos.kreisi.net/getjobinfo?id=${newJobId}&user_faction=${userAuth.faction}&user_ident=${encodeURIComponent(userAuth.user_ident)}&user_key=${encodeURIComponent(userAuth.user_key)}`).then(async(response)=>{
                console.log(response)
                if(response.status != 200) {
                    createNotification("alarm","Einsatzinfo konnte nicht empfangen werden!")
                    return;
                }
                let newJob = await response.json();


                //play appropriate sound
                if(!jobUpdated) {
                    switch(newJob.urgency) {
                    case "R1":
                        playSound("new_job_1");
                        break;
                    case "R2":
                        playSound("new_job_2");
                        break;
                    case "R3":
                        playSound("new_job_3");
                        break;
                    default:
                        playSound("new_job_2");
                    }
                    createNotification("alarm",`Neuer Einsatz: <b>${makeSafe(newJob.title)}</b>`)
                }

                //set new job info if available
                document.querySelector("span[data-job=title]").innerHTML = `<b>${makeSafe(newJob.urgency)}</b>${makeSafe(newJob.title)}`;
                document.querySelector("span[data-job=location]").innerText = newJob.location || "-/-";
                document.querySelector("span[data-job=caller]").innerText = newJob.caller || "-/-";
                document.querySelector("span[data-job=comment]").innerText = newJob.msg || "-/-";
                document.querySelector("span[data-job=timestamp]").innerText = new Date(parseInt(newJobId)).toLocaleTimeString("de");

                setTimeout(()=>{
                    fetch(`https://limnos.kreisi.net/getvehicles/${userAuth.faction}?user_ident=${encodeURIComponent(userAuth.user_ident)}&user_key=${encodeURIComponent(userAuth.user_key)}`).then(async(response)=>{
                        response.json().then((units)=>{
                            let jobUnits = "";

                            for(let i=0,iLength=Object.keys(units).length; i<iLength; i++) {
                                if(units[Object.keys(units)[i]].job == newJobId) {
                                    jobUnits += `<span>- ${makeSafe(Object.keys(units)[i])}</span>`;
                                }
                            }
                            document.querySelector("div[data-job=units]").innerHTML = jobUnits;//update unit list
                        });
                    });
                }, 5000);
            });
        }


        /* SOUND */

        function playSound(soundName) {
            let audioEl = document.querySelector("#audio");

            audioEl.src = `../src/${soundset}/${soundName}.mp3`;
            audioEl.play();
        }

    </script>
    <script src="../src/socket_handler.js"></script>
    <script src="../src/x_xxs.js"></script>
    <audio id="audio"></audio>
</body>
</html>